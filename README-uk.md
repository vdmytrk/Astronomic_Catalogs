# 🌌 **Astronomic Catalogs**
Цей проєкт демонструє повний стек архітектурних і розробницьких навичок з використанням технологій ASP.NET. Він повністю реалізований мною та не призначений для розгортання на сторонніх системах, а радше як демонстраційний проєкт для портфоліо, який демонструє структуровану бекенд-розробку, кастомізацію Identity та інтеграцію веб-інтерфейсу з віконними повідомленнями, темізацією та динамічним клієнтським скриптингом.

✨ Онлайн-деплой доступний тут: https://newastrocatalogs.azurewebsites.net   

⚖️ База даних розміщена на **Azure SQL Server**, а код підтримується на **Azure DevOps**, з **GitHub як дзеркалом лише для читання**:  
*   [Основний репозиторій *(активна розробка)*](https://dev.azure.com/voldmytcOrganization/_git/Astronomic%20Catalogs/)
*   [Дошка проекту та конвеєр](https://dev.azure.com/voldmytcOrganization/Astronomic%20Catalogs/_dashboards/dashboard/afcb5290-0b24-4d15-b980-73f188b335be)   
*   [Дзеркало на GitHub *(тільки для читання)*](https://github.com/vdmytrk/Astronomic_Catalogs) 


---

## 📑 **Зміст**
- [⚙️ Набір Технологій](#⚙%EF%B8%8F-**набір-технологій**)
- [📂 Структура Проєкту](#📂-**структура-проєкту**)
- [🏗️ Архітектура Та Дизайн](#🏗%EF%B8%8F-**архітектура-та-дизайн**)
- [🔐 Аутентифікація Та Авторизація](#%F0%9F%94%90-**аутентифікація-та-авторизація**)
  - [📧 Підтвердження Електронної Пошти](#📧-**підтвердження-електронної-пошти**)
- [🧠 Основні Моменти Збережених Процедур](#🧠-**основні-моменти-збережених-процедур**)
- [🧠 Ключові Процедури Та SQL-Дизайн](#🧠-**ключові-процедури-та-sql-дизайн**)
- [🧪 Тестування](#🧪-**тестування**)
- [⚡ Основні Акценти Розробника](#⚡-**основні-акценти-розробника**)
- [🚨 Примітки Щодо Розгортання](#🚨-**примітки-щодо-розгортання**)
- [🛠️ Інструменти](#🛠%EF%B8%8F-**інструменти**)
- [🚧 Дорожня Карта Та Поточні Роботи](#🚧-**дорожня-карта-та-поточні-роботи**)
- [📨 Контакти](#📨-**контакти**)

---

## ⚙️ **Набір Технологій**
| **Область**              | **Технології / Рішення**                                                            |
|--------------------------|-------------------------------------------------------------------------------------|
| **Фреймворк**            | ASP.NET Core 9 – MVC та Razor Pages                                                 |
| **Фронтенд**             | TypeScript, LESS, Bootstrap 5, SweetAlert2, SignalR (оновлення UI в реальному часі) |
| **Об'єднання та збірка** | Webpack, compilerconfig.json                                                        |
| **База даних**           | Azure SQL Server + EF Core 9 (model-first підхід + збережені процедури + сирий SQL) |
| **Аутентифікація**       | ASP.NET Identity + OAuth2 (Google, Microsoft), claim-и та політики ролей            |
| **Авторизація**          | На основі політик, з урахуванням каталогу та ролі (UI + маршрути)                   |
| **Надсилання листів**    | SMTP (Gmail) + `ICustomEmailSender` з підтвердженням за токеном                     |
| **Логування**            | NLog (`NLog.config.<середовище>`) + користувацький проміжний шар                    |
| **Кешування**            | `MemoryCache` + `ICacheService` з відстеженням ключів та термінами зберігання       |
| **Ліміти**               | Вбудований ASP.NET обмежувач з стратегіями: TokenBucket, SlidingWindow, FixedWindow |
| **DTO-обробка**          | Ручне зіставлення (AutoMapper лише як демонстрація)                                 |
| **Тестування**           | Модульне + інтеграційне тестування: NUnit, FakeItEasy, EF Core InMemory                                             |
| **Конвеєр**              | Azure Pipelines (`azure-pipelines.yml`)                                             |

⚡ **Примітка щодо AutoMapper**: Хоча в проєкті налаштовано AutoMapper як демонстрацію попереднього досвіду, в розгорнутому проєкті використовується ручне зіставлення через ліцензійні обмеження.  
⚡ **Адаптивність під мобільні пристрої** реалізована частково й потребує доопрацювання.  

---

## 📂 **Структура Проєкту**
**Основні компоненти**:
*   🌌 **Astronomic Catalogs** — ASP.NET MVC застосунок із:
    *   EF Core (SQL + збережені процедури)
    *   Аутентифікація та авторизація
    *   Користуваьцке налаштування обмежень запитів
    *   Проміжний шар логування
    *   Кешування
    *   Темізація інтерфейсу через Bootstrap 5 + LESS
*   🔐 **Identity Admin Area** — Razor Pages + MVC для адміністрування користувачів, ролей, claims з уніфікованим UI.
*   🧪 **Набір тестів** — тестування в реальних HTTP-сценаріях із використанням ізольованого середовища та тестових дублерів.  

---

## 🏗️ **Архітектура Та Дизайн**
*   **Кешування Результатів Збережених Процедур**  
    *   Використання `IMemoryCache` для кешування результатів збережених процедур із типовим терміном дії.  
    *   Логування спіпідінь і неспівпадінь кешу, підтримка інвалідації за ключем або префіксом.
*   **Користувацьке Логування В Проміжному Рівні**  
    *   Логування кожного вхідного HTTP-запиту та помилки разом із метаданими (статус-код, помилки, браузер, IP, джерело переходу, маршрут та інше).  
    *   Конфігурація залежна від параметрів середовища.  
    *   Маршрутизація помилок до централізованого `ErrorController` з окремими відображеннями для 403, 404 та 500.
*   **Ініціалізація Бази Даних**  
    *   Ініціалізація БД — включно зі створенням збережених процедур, функцій та початкових даних — **лише за явного увімкнення** через змінну середовища:
```json
  "InitializationDb": {
    "RestoreDatabase": true
  }
```
*   **Стратегія Проєктування Схеми**  
    *   Підхід *model-first* із використанням сирого SQL для таблиць не охоплених моделями.
*   **Імпорт даних з Excel**  
    *   Зчитування системних даних із попередньо оброблених `.xlsx`-файлів за допомогою `System.IO.Packaging` та OpenXml.  
    *   Паралельна обробка рядків із підтримкою скасування та передачею прогресу в реальному часі через SignalR.
*   **Обмеження Частоти Запитів**  
    *   Реалізація за допомогою вбудованого проміжного шару `AddRateLimiter` у ASP.NET.  
    *   Користувацькі політики для обмеження частоти запитів на основі користувача або IP.  
    *   Різні стратегії (FixedWindow, SlidingWindow, TokenBucket) для балансування між зареєстрованими та анонімними користувачами.
*   **Фронтенд**  
    *   Компіляція TypeScript у `wwwroot/js` з модульною клієнтською логікою.  
    *   Компіляція LESS у CSS із підтримкою перемикання тем під час виконання.  
    *   Інтеграція сповіщень SweetAlert2 через ES-модулі.
*   **Тестування**  
    *   Тести розміщені в `ACTests.Tests` і містять модульні тести, що перевіряють логіку контролерів/сервісів, а також інтеграційні тести в ізольованому середовищі.
    *   Інтеграційне тестування: повний HTTP-пайплайн на `WebApplicationFactory; перевірка політик/ролей/claims, навігації адмін-панелі та сценаріїв логіну через стандартні сторінки Identity.

---

## 🔐 **Аутентифікація Та Авторизація**
Підтримуються як локальні, так і зовнішні способи входу:  
*   Локальні облікові записи через **ASP.NET Identity** (автентифікація на основі cookie), включно з підтвердженням електронної пошти через Gmail SMTP та детальним логуванням спроб доставки.  
*   Зовнішні входи через **OAuth2** (Google і Microsoft особисті облікові записи) із зіставленням claim.

Авторизація на основі **claim** і **ролей**, з **доступом на основі політик**.


### 📧 **Підтвердження Електронної Пошти**
Процес підтвердження електронної пошти для реєстрації локального облікового запису, із захищеною доставкою на основі SMTP для кожного користувача за допомогою `ICustomEmailSender`, з вбудованим відстеженням, логуванням невдалих спроб відправлення та можливістю повторної відправки через UI.

Листи з підтвердженням містять:  
*   Захищене посилання для верифікації з токеном.  
*   Метадані повторної відправки (`LastRegisterEmailSent`, `CountRegisterEmailSent`).

appsettings.json example:
```json
  "AuthMessageSenderOptions": {
    "Email": "YOUR-EMAIL-ADDRESS",
    "Password": "YOUR-EMAIL-PASSWORD"
  },
  "Authentication": {
    "Google": {
      "ClientId": "YOUR-GOOGLE-CLIENT-ID",
      "ClientSecret": "YOUR-GOOGLE-CLIENT-SECRET"
    },
    "Microsoft": {
      "ClientId": "YOUR-MICROSOFT-CLIENT-ID",
      "ClientSecret": "YOUR-MICROSOFT-CLIENT-SECRET"
    }
  },
  "JwtSettings": {
    "Key": "YOUR-JWT-SECRET-KEY",
    "Issuer": "YOUR-JWT-ISSUER",
    "Audience": "ACAuthClient",
    "ExpireMinutes": ХВИЛИНИ
  }
```

---

## 🧠 **Основні Моменти Збережених Процедур**
У проєкті SQL-процедури використовуються як головний шар трансформації даних. Вони охоплюють:
*   **Обробка та Нормалізація даних** — перетворення сирих наборів даних у структурований реляційний формат.
*   **Дедуплікація та Агрегація** — вибір найбільш релевантних значень у групах записів за допомогою динамічного SQL.
*   **Гнучка фільтрація** — динамічні фільтри із діапазонами, умовами, JSON та сторінками.
*   **Транзакційна безпечність** — покриття тразакціями, логікою відкочування та типоорієнтований розбір.
*   **Журналювання та Обробка помилок** — детальне ведення журналу подій та обробка помилок з інформативними повідомленнями про помилки й повторним генеруванням для передачі на вищий рівень.

---

## 🧠 **Ключові Процедури Та SQL-Дизайн**      
*   🔄 ****Обробка та Нормалізація даних****  
    *   **CalculationPlanetarySystemData** — агрегація та трансформація нормалізованих даних у  структуровані пов’язані табличні дані. Групує зв’язані записи, витягує репрезентативні значення, обчислює похідні поля за математичними формулами та встановлює булеві прапорці на основі діапазонів.
    *   **FillNASAExoplanetCatalogUniquePlanets** — створення унікальних наборів даних шляхом вибору найновішого непорожнього значення кожного атрибуту серед згрупованих сутностей. Динамічне формування запиту для вибірки пріоритетних значень по кожному стовпцю на основі логіки фільтрації, специфічної для типу даних, та впорядкування за останньою датою. Забезпечення узгодженості для різнорідних типів даних, застосування значень за замовчуванням і формування кінцевого набору даних для вставки.
    *   **InsertCollinderCatalog** — перетворення необроблених записів у нормалізовану структуру. Розбір координатних даних, витяг по нумерованих атрибутах і загальне очищення даних для забезпечення узгодженості та цілісності.
    *   **InsertNGCICOpendatasoft** — обробка структурованих компонентів із вхідних рядків, визначення класифікації об’єктів і додаваня метаданих, зокрема джерело походження.
    *   **MigrateNGCICOStoNGCICO_W** — повна міграція та нормалізація даних. Виявлення дублікатів та підоб’єктів, відповідне розподілення даних, доповнення записів даними з додатковий таблиць.

*   🔍 ****Гнучкі Фільтраційні Процедури****  
    *   **GetFilteredNGCICData**, **GetFilteredPlanetarySystemsData** — застосування динамічних фільтрів із використанням nullable-умов, діапазонів і гнучкої логіки співпадінь.
    *   **GetFilteredPlanetsData** — розширена фільтрація з використанням JSON-масивів, фільтрів на основі діапазонів і розбиттям результатів на сторінки.

*   ⚙️ ****Продуктивність Та Масштабованість****  
    *   Використання індексованих запитів та оптимізованих умов для масштабованості.
    *   Спроєктовано з параметризованою логікою фільтрації для забезпечення підтримуваності.
    *   Централізоване логування для уніфікованої обробки помилок і моніторингу.

---

## 🧪 **Тестування**
Тестова інфраструктура включає створення користувачів з ролями/клеймами, симуляції UI-логінів, стабільної DI-конфігурації, заміни зовнішніх HTTP-викликів та побудови гнучких об’єктів `ClaimsPrincipal` із конфігурованими клеймами.

*   **Модульні тести**:
    *   **Перевірка окремих контролерів** (`HomeController`, `HomeAdminController`) — правильність повернення відображень, редіректів та моделей.
    *   **Тести сервісів** (`EmailSender`, кешування, логування) — відповідність бізнес-логіки, обробка помилок та коректний виклик залежностей.
    *   **Використання тестових дублерів** для ізоляції (імітація залежностей, фейкові репозиторії).
*   **Інфраструктура інтеграції**:
    *   **`TestAuthWebApplicationFactory`** — заміна схеми автентифікації на `TestAuth`; керування користувачем і його claims/ролями через `TestAuthHandlerOptions` та `TestUserBuilder`.
    *   **`LoginViaUIWebApplicationFactory`** — запуск повної Identity UI поверх in-memory `ApplicationDbContext`.
*   **Ізоляція та стабільність**:
    *   *In-memory* БД для інтеграційних тестів.
    *   Підміна/вимкнення зовнішніх сервісів.
    *   Середовище `Testing` і цілеспрямовані конфіг-override.
*   **Покриття інтеграції**:
    *   **Авторизація за claims/ролями**: очікувані `200/403`/редірект на логін.
    *   **Identity UI**: невдалий логін із повідомленням про помилку; успішний логін адміністратора з подальшим доступом.
    *   **Admin Area / `UsersController`**: доступ адміністратора та наявність ключових посилань; заборона доступу для не-адміністраторів.

---

## ⚡ **Основні Акценти Розробника**
✅ Модульна архітектура `Program.cs` із фабричною реєстрацією сервісів, користувацькими та умовними проміжним шарами.  
✅ Завантаження конфігурації на основі середовища з підтримкою налаштувань для окремих середовищ і безпечних secret-ів із **Azure Key Vault**.  
✅ Використання DTO у ключових місцях для відокремлення моделей EF Core від складної логіки відображення та компонентів, орієнтованих на користувача.  
✅ Користувацьке зіставлення між доменними моделями, DTO та ViewModel з підтримкою спрощення структури даних, умовного форматування та групування для складного UI-рендерингу та формування результатів.  
✅ Використання збережених SQL-процедур для обробки складних даних — надана перевага над LINQ враховуючи мій досвід в написанні оптимізованого SQL із використанням CTE, тимчасових таблиць і складних об’єднань.  

---

## 🚨 **Примітки Щодо Розгортання**
Це рішення **вимагає ручного налаштування та конфігурації** для повноцінного функціонування. Автоматичне розгортання або негайний запуск після клонування неможливі.

Основні передумови:  
*   Secret-и, рядок підключення та ключі автентифікації.  
*   Доступ до SQL Server і ініціалізована БД.  
*   SQL-скрипти для початкового заповнення бази (відсутні у репозиторії).

---

## 🛠️ **Інструменти**
*   Visual Studio 2022
*   Azure DevOps (Repos, Boards, Pipelines)
*   SQL Server Management Studio (Azure SQL DB)
*   Git (GitHub + Azure DevOps)
*   Git Flow (модель розгалуження)

---

## 🚧 **Дорожня Карта Та Поточні Роботи**
Попри повну функціональність і завершеність основних можливостей, розвиток проєкту триває з метою його вдосконалення та розширення. Заплановані покращення включають:  
*   Двофакторну автентифікацію для адміністраторського доступу.  
*   Розширення тестового покриття; Сценарне тестування.  
*   Поліпшену адаптацію під мобільні пристрої.  
*   Покращення адміністраторського інтерфейсу для масових операцій і зручнішого керування даними.  
*   Підтримку додаткових каталогів і функціональності.  
*   Удосконалення інтерфейсу та взаємодії з користувачем (UI/UX).

---

## 📨 **Контакти**
У разі бажання обговорити архітектурні рішення, структуру проєкту або питання щодо розгортання — звертайтесь:
*   Email: [voldmytc@gmail.com](mailto:voldmytc@gmail.com)
*   DOU: [https://dou.ua/users/volodimir-dmiterko-1/?from=menu-profile](https://dou.ua/users/volodimir-dmiterko-1/?from=menu-profile)
*   GitHub: [https://github.com/vdmytrk](https://github.com/vdmytrk)
*   Azure: [Volodymyr Dmyterko](https://dev.azure.com/voldmytcOrganization/Profile/_wiki/wikis/Profile.wiki/2/About-me)  
